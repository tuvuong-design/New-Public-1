H∆Ø·ªöNG D·∫™N K·∫æT N·ªêI FRONTEND (Bolt.new / Lovable / Firebase / Vite / Expo)
Backend: VideoShare (Next.js) ‚Äî t·∫•t c·∫£ API n·∫±m d∆∞·ªõi /api/...

================================================================================
0) T∆∞ duy t·ªïng quan (d·ªÖ hi·ªÉu)
- Backend ch·∫°y Next.js: https://BACKEND_DOMAIN
- B·∫°n c√≥ th·ªÉ c√≥ NHI·ªÄU frontend kh√°c nhau (nhi·ªÅu domain, Expo app, ...), nh∆∞ng d√πng CHUNG 1 backend.
- ƒê·ªÉ ch·ªëng l·∫°m d·ª•ng khi frontend kh√°c domain, backend h·ªó tr·ª£:
  (1) API Key (X-API-Key) + allowlist domain (allowedOrigins)
  (2) Auth (ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p) b·∫±ng JWT Cookie (d·ªÖ d√πng cho frontend AI tools)
  (3) Validation d·ªØ li·ªáu (Zod) + Rate Limit (Redis n·∫øu c√≥)

================================================================================
1) API KEY d√πng ƒë·ªÉ l√†m g√¨?
- Khi frontend ch·∫°y ·ªü domain kh√°c (Origin header kh√°c backend), c√°c API nh·∫°y c·∫£m (login/register/me/...) s·∫Ω y√™u c·∫ßu:
    Header: X-API-Key: <your_key>
- Admin s·∫Ω t·∫°o API key v√† khai b√°o allowedOrigins = c√°c domain ƒë∆∞·ª£c ph√©p g·ªçi.

1.1 T·∫°o API Key (ch·ªâ Admin)
POST /api/admin/api-keys
Body JSON:
{
  "name": "Bolt Frontend",
  "allowedOrigins": ["https://your-bolt-domain.com", "https://your-firebase.web.app"],
  "scopes": ["PUBLIC_READ","USER_WRITE","NFT_WRITE"]
}
Response:
- key (tr·∫£ 1 l·∫ßn duy nh·∫•t) => l∆∞u l·∫°i ngay.
- apiKey.id, keyLast4 ƒë·ªÉ qu·∫£n l√Ω.

1.2 D√πng API Key ·ªü frontend
- Vite/Bolt/Lovable/Firebase (browser):
  - fetch nh·ªõ b·∫≠t cookie: credentials: "include"
  - set header X-API-Key

V√≠ d·ª•:
fetch("https://BACKEND_DOMAIN/api/auth-jwt/me", {
  method: "GET",
  credentials: "include",
  headers: { "X-API-Key": API_KEY }
})

================================================================================
2) AUTH API ri√™ng (JWT Cookie) ‚Äî d·ªÖ t√≠ch h·ª£p h∆°n NextAuth
C√°c API n√†y t·∫°o cookie httpOnly:
- vs_access (15 ph√∫t)
- vs_refresh (30 ng√†y)

2.1 Register
POST /api/auth-jwt/register
Body:
{
  "email": "a@b.com",
  "password": "123456",
  "username": "tynguyen",
  "returnTokens": true
}
- returnTokens=true (ho·∫∑c header x-return-tokens: 1) => tr·∫£ th√™m accessToken/refreshToken trong JSON (h·ªØu √≠ch cho app mobile).
Browser th∆∞·ªùng KH√îNG c·∫ßn returnTokens (ƒë√£ c√≥ cookie).

2.2 Login
POST /api/auth-jwt/login
Body:
{
  "email": "a@b.com",
  "password": "123456",
  "returnTokens": true
}

2.3 Me (l·∫•y th√¥ng tin user)
GET /api/auth-jwt/me
- Browser: d√πng cookie (credentials: include) + X-API-Key (n·∫øu kh√°c domain)
- Mobile: c√≥ th·ªÉ d√πng Bearer token:
  Authorization: Bearer <accessToken>

2.4 Refresh token
POST /api/auth-jwt/refresh
- M·∫∑c ƒë·ªãnh ƒë·ªçc vs_refresh cookie
- N·∫øu mu·ªën nh·∫≠n token trong JSON: set header x-return-tokens: 1

2.5 Logout
POST /api/auth-jwt/logout

================================================================================
3) CORS + Cookie (quan tr·ªçng)
- N·∫øu frontend kh√°c domain backend:
  - backend ch·ªâ cho ph√©p n·∫øu c√≥ X-API-Key h·ª£p l·ªá (·ªü c√°c route auth-jwt)
  - b·∫Øt bu·ªôc d√πng HTTPS ƒë·ªÉ cookie SameSite=None ho·∫°t ƒë·ªông.
  - fetch ph·∫£i c√≥: credentials: "include"

================================================================================
4) C√°c API public (kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)
Tu·ª≥ t·ª´ng route trong project, th∆∞·ªùng c√≥:
- GET /api/public/videos
- GET /api/public/videos/[id]
C√°c route public c√≥ th·ªÉ kh√¥ng b·∫Øt bu·ªôc API key (t√πy ch√≠nh s√°ch b·∫°n mu·ªën).

================================================================================
5) Rate limit / Validation / Ph√¢n quy·ªÅn
- Validation: Zod ·ªü c√°c route auth-jwt v√† admin api-keys.
- Rate limit: /lib/api/rateLimit.ts (Redis n·∫øu c√≥, kh√¥ng c√≥ th√¨ fail-open cho dev).
- Ph√¢n quy·ªÅn:
  - Admin routes y√™u c·∫ßu role ADMIN (NextAuth session).
  - Auth-jwt routes ch·ªâ x√°c th·ª±c ng∆∞·ªùi d√πng; quy·ªÅn n√¢ng cao b·∫°n c√≥ th·ªÉ ki·ªÉm so√°t theo role trong payload.

================================================================================
6) Checklist cho Bolt/Lovable/Firebase
- C√≥ BACKEND_DOMAIN
- C√≥ API_KEY
- D√πng c√°c endpoint auth-jwt ƒë·ªÉ login/register
- Khi g·ªçi API c·∫ßn cookie: fetch credentials: "include"
- N·∫øu g·∫∑p l·ªói 401: ki·ªÉm tra Origin/allowedOrigins v√† API key




========================
PH·∫¶N M·ªöI: API D√ÄNH CHO FRONTEND NGO√ÄI (Bolt/Lovable/Firebase/Expo)
========================

üëâ Khuy·∫øn ngh·ªã d√πng nh√≥m endpoint /api/external/* cho c√°c frontend/app n·∫±m ·ªü domain kh√°c nhau.
Nh√≥m n√†y lu√¥n:
- B·∫ÆT BU·ªòC g·ª≠i header: X-API-Key
- N·∫øu g·ªçi t·ª´ browser (c√≥ Origin): backend s·∫Ω ki·ªÉm tra Origin c√≥ n·∫±m trong allowedOrigins c·ªßa API key hay kh√¥ng.
- C√≥ th·ªÉ d√πng ƒëƒÉng nh·∫≠p JWT (cookie ho·∫∑c Bearer token) ƒë·ªÉ g·ªçi c√°c API c·∫ßn login.

1) AUTH (JWT cookie / Bearer)
- POST /api/external/auth/register  (re-export t·ª´ /api/auth-jwt/register)
- POST /api/external/auth/login     (re-export t·ª´ /api/auth-jwt/login)
- POST /api/external/auth/refresh   (re-export t·ª´ /api/auth-jwt/refresh)
- GET  /api/external/auth/me        (re-export t·ª´ /api/auth-jwt/me)
- POST /api/external/auth/logout    (re-export t·ª´ /api/auth-jwt/logout)

2) VIDEO LIST (public)
- GET /api/external/public/videos?sort=new|views|likes&page=1&take=24
  Header: X-API-Key: ...
  (Kh√¥ng b·∫Øt bu·ªôc login)

3) VIEW
- POST /api/external/views
  Body: { "videoId": "..." }
  Header: X-API-Key: ...
  (Rate limit theo IP + apiKey)

4) LIKE (c·∫ßn login)
- POST /api/external/likes
  Body: { "videoId": "..." }
  Header: X-API-Key: ...
  + Cookie (credentials: include) HO·∫∂C Authorization: Bearer <accessToken>

5) COMMENT
- GET /api/external/comments?videoId=...
  Header: X-API-Key: ...
  (login optional: n·∫øu login th√¨ c√≥ th·ªÉ th·∫•y th√™m th√¥ng tin theo quy·ªÅn)

- POST /api/external/comments
  Body: { "videoId": "...", "content": "..." }
  Header: X-API-Key: ...
  + Cookie/Bearer (b·∫Øt bu·ªôc)

6) NFT MARKET (c·∫ßn login)
- POST /api/external/nft/listings/create
  Body: { "itemId": "...", "priceStars": 123 }
  Header: X-API-Key: ...
  + Cookie/Bearer

- POST /api/external/nft/listings/{id}/cancel
  Header: X-API-Key: ...
  + Cookie/Bearer

- POST /api/external/nft/listings/{id}/buy
  Header: X-API-Key: ...
  + Cookie/Bearer

------------------------
SCOPES g·ª£i √Ω khi t·∫°o API key
------------------------
- PUBLIC_READ: ƒë·ªçc public
- VIDEO_READ: ƒë·ªçc danh s√°ch video (external)
- VIEW_WRITE: tƒÉng view
- LIKE_WRITE: like/unlike
- COMMENT_READ / COMMENT_WRITE
- NFT_READ / NFT_WRITE
- AUTH: d√πng auth endpoint (n·∫øu b·∫°n mu·ªën gi·ªõi h·∫°n)
- ADMIN: ch·ªâ d√πng cho admin tools

N·∫øu scopes ƒë·ªÉ r·ªóng/kh√¥ng c√≥ => m·∫∑c ƒë·ªãnh cho ph√©p (ƒë·ªÉ kh√¥ng l√†m g√£y key c≈©).


============================
NFT MARKET (External) - D√ôNG CHO FRONTEND AI (kh√¥ng c·∫ßn SSR)
============================
C√°c API n√†y y√™u c·∫ßu header X-API-Key.

1) Danh s√°ch listing ƒëang b√°n
GET /api/external/nft/market/listings?page=1&take=24&status=ACTIVE&collectionId=...&sellerId=...

2) Danh s√°ch collection
GET /api/external/nft/market/collections?page=1&take=24&creatorId=...&q=...

3) Danh s√°ch item
GET /api/external/nft/market/items?page=1&take=24&collectionId=...&ownerId=...&q=...&includeListing=true

============================
N·∫†P SAO B·∫∞NG TI·ªÄN ·∫¢O (Crypto Topup)
============================
(1) L·∫•y c√°c g√≥i n·∫°p (packages)
GET /api/external/stars/topup/packages?chain=SOLANA

(2) T·∫°o y√™u c·∫ßu n·∫°p (deposit)
POST /api/external/stars/topup/deposits/create
Body: { packageId, couponCode? }
=> Tr·∫£ v·ªÅ ƒë·ªãa ch·ªâ n·∫°p + memo (n·∫øu chain c·∫ßn memo).

(3) Xem tr·∫°ng th√°i deposit
GET /api/external/stars/topup/deposits/{id}

L∆∞u √Ω: Backend s·∫Ω ghi nh·∫≠n deposit khi c√≥ webhook/cron ƒë·ªëi so√°t txHash (ph·∫ßn n√†y tu·ª≥ t√≠ch h·ª£p provider).

============================
PIN B·∫¢O M·∫¨T (mua NFT / t·∫∑ng sao / ƒë√∫c NFT)
============================
- Set PIN: POST /api/external/security/pin/set  (login JWT)
- Verify PIN: POST /api/external/security/pin/verify (login JWT)

G·ª£i √Ω: V·ªõi c√°c action nh·∫°y c·∫£m, frontend g·ª≠i k√®m pin trong body ho·∫∑c header X-PIN.

============================
POLICY: VIEW_WRITE B·∫ÆT BU·ªòC
============================
Endpoint tƒÉng view: POST /api/external/views
- B·∫ÆT BU·ªòC API key c√≥ scope VIEW_WRITE (kh√¥ng c√≥ scope s·∫Ω b·ªã ch·∫∑n).

POST /api/external/stars/gift  { toUserId, stars, message?, idempotencyKey?, pin? }


POST /api/external/nft/mint/clip { clipId, chain?, editionSize?, pin? }

================================================================================
10) B·∫£o m·∫≠t m·ªõi: strictScopes + PIN cho c√°c h√†nh ƒë·ªông nh·∫°y c·∫£m
- M·ªôt s·ªë endpoint ƒë√£ b·∫≠t `strictScopes: true` cho scope:
  - USER_WRITE
  - NFT_WRITE
  - VIEW_WRITE (si·∫øt policy views)
=> Nghƒ©a l√† API Key B·∫ÆT BU·ªòC ph·∫£i c√≥ scope ƒë√∫ng (kh√¥ng ‚Äúth·ª´a k·∫ø‚Äù t·ª´ PUBLIC_READ).

- PIN (m√£ 4-12 s·ªë) ƒë∆∞·ª£c y√™u c·∫ßu n·∫øu user ƒë√£ c√†i PIN:
  - Mua NFT, t·∫∑ng sao, ƒë√∫c NFT
  - B√°n NFT / t·∫°o listing, hu·ª∑ listing, ch·ªânh gi√° listing (m·ªõi)
N·∫øu user ch∆∞a set PIN th√¨ kh√¥ng b·∫Øt bu·ªôc g·ª≠i pin.

Headers ph·ªï bi·∫øn:
- X-API-Key: <api key>
- Cookie JWT: t·ª± c√≥ sau khi login

Body (v√≠ d·ª•):
{ "pin": "1234", ... }

================================================================================
11) Webhook n·∫°p coin (USDT/USDC) -> auto-credit Stars
M·ª•c ti√™u: webhook nh·∫≠n tx -> match memo/depositId ho·∫∑c toAddress -> CONFIRMED/CREDITED -> c·ªông starBalance + t·∫°o StarTransaction.

B·∫£o m·∫≠t: b·∫Øt bu·ªôc header:
- x-webhook-secret: <CRYPTO_WEBHOOK_SECRET>

Endpoints:
- POST /api/webhooks/crypto/helius   (Solana / Helius)
- POST /api/webhooks/crypto/alchemy  (BSC/EVM / Alchemy)  (th√™m ?chain=BSC n·∫øu c·∫ßn)
- POST /api/webhooks/crypto/tron     (TRON / payload chu·∫©n ho√° t·ª´ watcher c·ªßa b·∫°n)
- POST /api/webhooks/crypto          (generic wrapper {provider, chain, payload})

Env c·∫ßn set:
- CRYPTO_WEBHOOK_SECRET
- PAYMENTS_AUTO_CREDIT=true/false
- PAYMENTS_TOLERANCE_BPS (m·∫∑c ƒë·ªãnh 150 = 1.5%)

L∆∞u √Ω:
- Helius c√≥ th·ªÉ retry v√† g·ª≠i tr√πng -> h·ªá th·ªëng dedupe theo WebhookAuditLog(provider+sha256)
- N·∫øu amount l·ªách so v·ªõi expected qu√° tolerance => deposit chuy·ªÉn NEEDS_REVIEW (kh√¥ng auto-credit)


====================
WATCHER TRON/BSC (T·ª∞ ƒê·ªòNG C·ªòNG SAO)
====================
‚úÖ M·ª•c ti√™u: khi user n·∫°p USDT/USDC v√†o v√≠ n·∫°p (custodial address), h·ªá th·ªëng t·ª±:
1) ph√°t hi·ªán giao d·ªãch (watcher polling ho·∫∑c provider webhook)
2) match depositId / toAddress
3) set tr·∫°ng th√°i: OBSERVED -> CONFIRMED -> CREDITED
4) c·ªông sao (starBalance) + t·∫°o StarTransaction

1) BSC (USDT/USDC)
- C√°ch A (khuy√™n d√πng n·∫øu c√≥ Alchemy): d√πng webhook Alchemy Notify g·ªçi v√†o:
  POST /api/webhooks/crypto/alchemy
  Header: x-webhook-secret = CRYPTO_WEBHOOK_SECRET

- C√°ch B (kh√¥ng c·∫ßn Alchemy): b·∫≠t polling watcher trong worker:
  env:
    EVM_RPC_URL_BSC=...
    PAYMENTS_WATCH_BSC_EVERY_MS=60000
    PAYMENTS_EVM_CONFIRMATIONS=5
    PAYMENTS_WATCH_BLOCK_WINDOW=2000
  Worker s·∫Ω t·ª± qu√©t Transfer logs (ERC20) c·ªßa USDT/USDC v√† g·ªçi reconcile_deposit.

2) TRON (TRC20 USDT/USDC)
- TronGrid th∆∞·ªùng kh√¥ng c√≥ webhook transfer ·ªïn ƒë·ªãnh => d√πng polling watcher:
  env:
    TRONGRID_API_URL=https://api.trongrid.io
    TRONGRID_API_KEY=...
    PAYMENTS_WATCH_TRON_EVERY_MS=60000

‚ö†Ô∏è L∆∞u √Ω:
- C·∫ßn c√≥ Token rows trong DB cho USDT/USDC theo t·ª´ng chain (contractAddress + decimals).
- M·ªói deposit n√™n c√≥ 1 ƒë·ªãa ch·ªâ n·∫°p ri√™ng (custodial address) ƒë·ªÉ match ch√≠nh x√°c (TRON/EVM kh√¥ng c√≥ memo).
- N·∫øu s·ªë ti·ªÅn l·ªách expected qu√° tolerance => chuy·ªÉn NEEDS_REVIEW (kh√¥ng auto-credit).


===== TH√îNG B√ÅO TELEGRAM (tu·ª≥ ch·ªçn) =====
- B·∫≠t th√¥ng b√°o n·∫°p sao: TELEGRAM_NOTIFY_ENABLED=true
- Set TELEGRAM_BOT_TOKEN v√† TELEGRAM_CHAT_ID
- Khi deposit CREDITED ho·∫∑c NEEDS_REVIEW, backend s·∫Ω g·ª≠i message.
